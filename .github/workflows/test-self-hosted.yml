name: Run code from branch (no Node)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  run-on-vm:
    runs-on: self-hosted

    steps:
      - name: Show context
        run: |
          echo "Ref: $GITHUB_REF"
          echo "Branch: $GITHUB_REF_NAME"
          echo "Commit: $GITHUB_SHA"

      - name: Clone this repo/branch manually
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean previous clone
          rm -rf repo

          # Clone using the built-in GITHUB_TOKEN (no extra secrets needed)
          git clone https://x-access-token:${GITHUB_TOKEN}@git@github.com:oja-oba/oja-oba.git repo

          cd repo

          # Check out the branch / commit that triggered the workflow
          git fetch origin
          git checkout "$GITHUB_REF_NAME"
          git reset --hard "$GITHUB_SHA"

          echo "Now at:"
          git log -1 --oneline

          # ðŸ‘‰ Run your real code here, for example:
          # ./scripts/test_runner.sh
          echo "Running code from branch $GITHUB_REF_NAME at commit $GITHUB_SHA"